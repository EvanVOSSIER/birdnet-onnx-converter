name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ruff
        run: pip install ruff

      - name: Run ruff check
        run: ruff check .

      - name: Run ruff format check
        run: ruff format --check .

  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install mypy

      - name: Run mypy
        run: mypy convert.py optimize.py --ignore-missing-imports

  test:
    runs-on: ubuntu-latest
    needs: [lint, typecheck]
    strategy:
      matrix:
        # Python 3.12 excluded: tf2onnx requires numpy<1.24 which has no 3.12 wheels
        python-version: ["3.11"]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install cmake
        run: sudo apt-get update && sudo apt-get install -y cmake

      - name: Install dependencies
        run: |
          # Use venv to isolate from container's pre-installed packages
          python -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          # Pin tensorflow 2.14 + numpy<1.24 for tf2onnx compatibility (np.bool removed in 1.24)
          pip install "numpy>=1.21,<1.24"
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install "tensorflow>=2.14,<2.15" tf2onnx
          # Reinstall numpy<1.24 to override any dependency upgrades
          pip install "numpy>=1.21,<1.24"

      - name: Run pytest
        run: |
          source .venv/bin/activate
          pytest tests/ -v

      # Birda inference comparison (build from source until action is available)
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache birda build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            /tmp/birda/target
          key: ${{ runner.os }}-birda-${{ hashFiles('/tmp/birda/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-birda-

      - name: Build birda
        run: |
          git clone --depth 1 --branch v1.3.0 https://github.com/tphakala/birda.git /tmp/birda
          cd /tmp/birda && cargo build --release
          echo "/tmp/birda/target/release" >> $GITHUB_PATH

      - name: Run birda inference on FP32 model
        run: |
          mkdir -p tests/output/fp32
          birda tests/fixtures/test_audio.wav \
            --model tests/output/BirdNET_fp32.onnx \
            --output-dir tests/output/fp32 \
            --format csv \
            --min-confidence 0.1
          mv tests/output/fp32/*.csv tests/output/fp32_predictions.csv

      - name: Compare FP32 predictions against baseline
        run: |
          python tests/compare_predictions.py \
            tests/fixtures/baseline_predictions.csv \
            tests/output/fp32_predictions.csv \
            --tolerance 0.01 \
            --min-confidence 0.10

      - name: Run birda inference on FP16 model
        run: |
          mkdir -p tests/output/fp16
          birda tests/fixtures/test_audio.wav \
            --model tests/output/BirdNET_fp16.onnx \
            --output-dir tests/output/fp16 \
            --format csv \
            --min-confidence 0.1
          mv tests/output/fp16/*.csv tests/output/fp16_predictions.csv

      - name: Compare FP16 predictions against baseline
        run: |
          python tests/compare_predictions.py \
            tests/fixtures/baseline_predictions.csv \
            tests/output/fp16_predictions.csv \
            --tolerance 0.01 \
            --min-confidence 0.10
